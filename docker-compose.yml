version: "3.8"
services:
  auth:
    build:
      context: ./auth/authentication
      dockerfile: Dockerfile
    environment:
      SPRING_DATASOURCE_URL: "jdbc:postgresql://ep-long-feather-a1jvn6ah-pooler.ap-southeast-1.aws.neon.tech:5432/neondb?sslmode=require&channel_binding=require"
      SPRING_DATASOURCE_USERNAME: "neondb_owner"
      SPRING_DATASOURCE_PASSWORD: "npg_uDPTyF9b3eNp"
      NOTIFICATION_SERVICE_URL: "http://notification:8083"
      FRONTEND_URL: "http://localhost:3000"
    # No local db dependency; service uses Neon DB via SPRING_DATASOURCE_URL

    ports:
      - "8081:8081"

  notification:
    build:
      context: ./Backend/notification-system
      dockerfile: Dockerfile
    # Notification does not require a local database
    ports:
      - "8083:8083"
    # Provide notification provider credentials via environment variables.
    # Recommended: create a local (untracked) file `Backend/notification-system/.env` with
    # uppercase underscore names (SENDGRID_API_KEY, TWILIO_ACCOUNT_SID, etc.)
    # and/or export these vars in your shell. Do NOT commit the real .env to git.
    environment:
      SPRING_DATASOURCE_URL: "jdbc:h2:mem:appdb;DB_CLOSE_DELAY=-1;DB_CLOSE_ON_EXIT=FALSE"
      SENDGRID_API_KEY: "${SENDGRID_API_KEY}"
      TWILIO_ACCOUNT_SID: "${TWILIO_ACCOUNT_SID}"
      TWILIO_AUTH_TOKEN: "${TWILIO_AUTH_TOKEN}"
      TWILIO_PHONE_NUMBER: "${TWILIO_PHONE_NUMBER}"

  employee-service:
    build:
      context: ./employee-service
      dockerfile: Dockerfile
    environment:
      SPRING_DATASOURCE_URL: "jdbc:postgresql://ep-old-bread-a4lduu7m-pooler.us-east-1.aws.neon.tech:5432/neondb?sslmode=require&channel_binding=require"
      SPRING_DATASOURCE_USERNAME: "neondb_owner"
      SPRING_DATASOURCE_PASSWORD: "npg_cx0ZlPBeyT6R"
    # No local db dependency; service uses Neon DB via SPRING_DATASOURCE_URL
    ports:
      - "8070:8070"

  chatbot-backend:
    build:
      context: ./chatbot-backend
      dockerfile: Dockerfile
    # Chatbot does not require a local database
    environment:
      # Set GEMINI_API_URL and GEMINI_API_KEY via host env or a .env file (do NOT commit secrets)
      GEMINI_API_URL: "${GEMINI_API_URL}"
      GEMINI_API_KEY: "${GEMINI_API_KEY}"
      # Ensure the customer service URL points to the compose service by default
      CUSTOMER_SERVICE_URL: "${CUSTOMER_SERVICE_URL:-http://customer_service:8085}"
    ports:
      - "8086:8086"

  admin:
    build:
      context: ./admin
      dockerfile: Dockerfile
    environment:
      SPRING_DATASOURCE_URL: "jdbc:postgresql://ep-raspy-cherry-ahvd3mbd-pooler.c-3.us-east-1.aws.neon.tech:5432/neondb?sslmode=require&channel_binding=require"
      SPRING_DATASOURCE_USERNAME: "neondb_owner"
      SPRING_DATASOURCE_PASSWORD: "npg_QMq8Be5whTDA"
    # No local db dependency; service uses Neon DB via SPRING_DATASOURCE_URL
    ports:
      - "8082:8082"

  customer_service:
    build:
      context: ./Customer_Service/customer_service
      dockerfile: Dockerfile
    environment:
      SPRING_DATASOURCE_URL: "jdbc:postgresql://ep-weathered-paper-a1e2pqli-pooler.ap-southeast-1.aws.neon.tech:5432/neondb?sslmode=require"
      SPRING_DATASOURCE_USERNAME: "neondb_owner"
      SPRING_DATASOURCE_PASSWORD: "npg_7qejET0MJmlF"
    # No local db dependency; service uses Neon DB via SPRING_DATASOURCE_URL
    ports:
      - "8085:8085"

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        NEXT_PUBLIC_API_BASE_URL: http://localhost:8081/api
    ports:
      - "3000:3000"
    depends_on:
      - auth
      - notification

volumes:
  rabbitmqdata:
