version: "3.8"
services:
  auth:
    build:
      context: ./auth/authentication
      dockerfile: Dockerfile
    environment:
      SPRING_DATASOURCE_URL: "jdbc:postgresql://ep-long-feather-a1jvn6ah-pooler.ap-southeast-1.aws.neon.tech:5432/neondb?sslmode=require&channel_binding=require"
      SPRING_DATASOURCE_USERNAME: "neondb_owner"
      SPRING_DATASOURCE_PASSWORD: "npg_uDPTyF9b3eNp"
      # Twilio placeholders (set real values via env or secrets for production)
      TWILIO_ACCOUNT_SID: ""
      TWILIO_AUTH_TOKEN: ""
      TWILIO_PHONE_NUMBER: ""
      NOTIFICATION_SERVICE_URL: "http://notification:8083"
      FRONTEND_URL: "http://localhost:3000"
    # No local db dependency; service uses Neon DB via SPRING_DATASOURCE_URL

    ports:
      - "8081:8081"

  notification:
    build:
      context: ./Backend/notification-system
      dockerfile: Dockerfile
    # Notification uses the shared Neon Postgres DB (override defaults in application.properties)
    environment:
      SPRING_DATASOURCE_URL: "jdbc:postgresql://ep-long-feather-a1jvn6ah-pooler.ap-southeast-1.aws.neon.tech:5432/neondb?sslmode=require&channel_binding=require"
      SPRING_DATASOURCE_USERNAME: "neondb_owner"
      SPRING_DATASOURCE_PASSWORD: "npg_uDPTyF9b3eNp"
    ports:
      - "8083:8083"

  employee-service:
    build:
      context: ./employee-service
      dockerfile: Dockerfile
    environment:
      SPRING_DATASOURCE_URL: "jdbc:postgresql://ep-old-bread-a4lduu7m-pooler.us-east-1.aws.neon.tech:5432/neondb?sslmode=require&channel_binding=require"
      SPRING_DATASOURCE_USERNAME: "neondb_owner"
      SPRING_DATASOURCE_PASSWORD: "npg_cx0ZlPBeyT6R"
    # No local db dependency; service uses Neon DB via SPRING_DATASOURCE_URL
    ports:
      - "8070:8070"

  chatbot-backend:
    build:
      context: ./chatbot-backend
      dockerfile: Dockerfile
    # Chatbot does not require a local database
    environment:
      # Set GEMINI_API_URL and GEMINI_API_KEY via host env or a .env file (do NOT commit secrets)
      GEMINI_API_URL: "${GEMINI_API_URL}"
      GEMINI_API_KEY: "${GEMINI_API_KEY}"
      # Ensure the customer service URL points to the compose service by default
      CUSTOMER_SERVICE_URL: "${CUSTOMER_SERVICE_URL:-http://customer_service:8085}"
    ports:
      - "8086:8086"

  admin:
    build:
      context: ./admin
      dockerfile: Dockerfile
    environment:
      SPRING_DATASOURCE_URL: "jdbc:postgresql://ep-raspy-cherry-ahvd3mbd-pooler.c-3.us-east-1.aws.neon.tech:5432/neondb?sslmode=require&channel_binding=require"
      SPRING_DATASOURCE_USERNAME: "neondb_owner"
      SPRING_DATASOURCE_PASSWORD: "npg_QMq8Be5whTDA"
    # No local db dependency; service uses Neon DB via SPRING_DATASOURCE_URL
    ports:
      - "8082:8082"

  customer_service:
    build:
      context: ./Customer_Service/customer_service
      dockerfile: Dockerfile
    environment:
      SPRING_DATASOURCE_URL: "jdbc:postgresql://ep-weathered-paper-a1e2pqli-pooler.ap-southeast-1.aws.neon.tech:5432/neondb?sslmode=require"
      SPRING_DATASOURCE_USERNAME: "neondb_owner"
      SPRING_DATASOURCE_PASSWORD: "npg_7qejET0MJmlF"
      ADMIN_SERVICE_URL: "http://admin:8082"
    # No local db dependency; service uses Neon DB via SPRING_DATASOURCE_URL
    ports:
      - "8085:8085"

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        # Client-side (baked into the Next.js bundle at build time) - used by browser code
        NEXT_PUBLIC_AUTH_URL: http://localhost:8081/api
        NEXT_PUBLIC_ADMIN_URL: http://localhost:8082/api
        NEXT_PUBLIC_NOTIFICATION_URL: http://localhost:8083/api
        NEXT_PUBLIC_CUSTOMER_URL: http://localhost:8085/api
        NEXT_PUBLIC_EMPLOYEE_URL: http://localhost:8070/api
        # Backwards-compatible fallback used by older code paths
        NEXT_PUBLIC_API_BASE_URL: http://localhost:8081/api
    environment:
      # Server-side URLs (available to Next.js server/runtime inside the container) - use docker compose service names
      SERVER_AUTH_URL: http://auth:8081/api
      SERVER_ADMIN_URL: http://admin:8082/api
      SERVER_NOTIFICATION_URL: http://notification:8083/api
      SERVER_CUSTOMER_URL: http://customer_service:8085/api
      SERVER_EMPLOYEE_URL: http://employee-service:8070/api
    ports:
      - "3000:3000"
    depends_on:
      - auth
      - admin
      - notification
      - customer_service
      - employee-service

volumes:
  rabbitmqdata:
